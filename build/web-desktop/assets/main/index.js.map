{"version":3,"sources":["../file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/GameManager.ts","../file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/HttpClient.ts","../file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/scripts/ResolutionAdjuster.ts","../file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/cocos-telegram-miniapps/scripts/file:/Users/liuyingbin/code/github/src/danielliu029/TgTest/assets/cocos-telegram-miniapps/scripts/telegram-web.ts"],"names":["ccclass","property","_decorator","_dec","_dec2","Label","_dec3","_dec4","_dec5","_dec6","_dec7","_dec8","Button","_dec9","_class3","GameManager","Component","constructor","super","arguments","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","_descriptor4","_descriptor5","_descriptor6","_descriptor7","_descriptor8","this","connectUI","_base_url","_local_host","_login_path","_test_login_path","_bind_ton_wallet_path","_unbind_ton_wallet_path","_dance_end_path","_user","_token","onLoad","console","info","_test_login","testLogin","connectButton","enabled","initTonConnect","TelegramWebApp","Instance","init","then","res","success","decodeURIComponent","getTelegramInitData","debugInfo","string","tgLogin","start","update","deltaTime","onConnect","isConnected","doDisconnect","openModal","onDanceEnd","danceEnd","onShare","share","tg_id","TonConnectUI","manifestUrl","onModalStateChange","state","log","updateConnect","onStatusChange","checkBindWallet","ton_wallet","connected","error","[object Object]","disconnect","unbindWallet","addressLbl","connectLbl","strAddress","Address","parseRaw","account","address","toString","testOnly","bounceable","bindTonWallet","setUserInfo","response","user","token","idLbl","username","nameLbl","first_name","last_name","pointsLbl","points","data","encodeURIComponent","HttpClient","post","initData","wallet","dic","addPoints","_applyDecoratedDescriptor","_class2","prototype","configurable","enumerable","writable","initializer","_class","_RF","pop","url","options","fetch","ok","Error","status","statusText","json","baseUrl","path","contentType","params","authToken","URL","forEach","_ref","key","value","searchParams","append","headers","Content-Type","request","method","body","JSON","stringify","CCInteger","CCBoolean","isAutoFit","autoFit","window","addEventListener","bind","designSize","View","instance","getDesignResolutionSize","viewPortRect","getViewportRect","setOrientation","height","width","rateV","Math","abs","size","setDesignResolutionSize","fixedWidthDesignWidth","fixedWidthDesignHeight","ResolutionPolicy","FIXED_WIDTH","fixedHeightDesignWidth","fixedHeightDesignHeight","FIXED_HEIGHT","tgLoadPromise","Promise","resolve","reject","sys","platform","Platform","MOBILE_BROWSER","DESKTOP_BROWSER","script","document","createElement","src","async","onload","intervalId","setInterval","Telegram","WebApp","clearInterval","onerror","head","appendChild","_tgWebAppJS","_instance","openTelegramLink","openLink","text","shareUrl","shareToStory","media_url","shareText","widget_link_url","widget_link_name","widget_link","name","getTelegramWebApp","getTelegramWebAppInitData","initDataUnsafe","getTelegramUser","openInvoice","callback","alert","message","showAlert"],"mappings":"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","file":"all.js","sourcesContent":["import { _decorator, Component, Label, Button, Node, randomRangeInt } from 'cc';\nimport { TelegramWebApp, WebAppInitData } from '../cocos-telegram-miniapps/scripts/telegram-web';\nimport { TonConnectUI, Address } from '@ton/cocos-sdk';\nimport { HttpClient } from './HttpClient';\n\nconst { ccclass, property } = _decorator;\n\ninterface ResponseLogin {\n    status: string;\n    user?: User;\n    token?: string; //授权token\n    message?: string;\n    code?: number;\n}\n\ninterface User {\n    tg_id: number; //telegram 用户唯一id\n    username: string; \n    first_name: string;\n    last_name: string;\n    photo_url: string;\n    ton_wallet: string;\n    points: number;  //用户游戏累积积分\n    referral_tg_id: number; //推荐者tg id\n    acc_referral_points: number;  //累积推荐所获得的积分奖励\n    acc_referral_number: number;  //累积推荐的人数\n    last_interaction: number; //最后一次交互时间\n}\n\ninterface ResponseBindWallet {\n    status: string;\n    wallet?: string;\n    message?: string;\n    code?: number;\n}\n\ninterface ResponseUnBindWallet {\n    status: string;\n    message?: string;\n    code?: number;\n}\n\ninterface ResponseDanceEnd {\n    status: string;\n    points?: number;\n    message?: string;\n    code?: number;\n}\n\n@ccclass('GameManager')\nexport class GameManager extends Component {\n    @property(Label)\n    idLbl: Label = null;\n\n    @property(Label)\n    nameLbl: Label = null;\n\n    @property(Label)\n    addressLbl: Label = null;\n\n    @property(Label)\n    pointsLbl: Label = null;\n\n    @property(Label)\n    connectLbl: Label = null;\n\n    @property(Label)\n    debugInfo: Label = null;\n\n    @property(Button)\n    connectButton: Button = null;\n\n    @property(Button)\n    danceEndButton: Button = null;\n\n    protected connectUI: TonConnectUI = null;\n\n\n    private static _local_host: boolean = false;\n    private static _test_login: boolean = false;\n    private _base_url: string = GameManager._local_host ? \"http://127.0.0.1:5000\" : \"https://alpha.audiera.fi\";\n    private _login_path: string = \"/api/auth/telegram\"; //登录接口\n    private _test_login_path: string = \"/api/test/telegram\"; //测试无需验证登录接口\n    private _bind_ton_wallet_path: string = \"/api/bindTonWallet\"; //绑定ton 钱包接口\n    private _unbind_ton_wallet_path: string = \"/api/unbindTonWallet\"; //解绑ton 钱包接口\n    private _dance_end_path: string = \"/api/danceEnd\"; //跳舞结束统计积分接口\n    private _user: User = null;\n    private _token: string = \"\";\n\n    protected onLoad() {\n        console.info(\"onLoad\");\n        if (GameManager._test_login) {\n            this.testLogin();\n            this.connectButton.enabled = false;\n        } else {\n            this.connectButton.enabled = true;\n            this.initTonConnect();\n            //获取Telegram用户信息，用于小游戏登录，使用user id作为登录的唯一id\n            TelegramWebApp.Instance.init().then(res => {\n                console.info(\"telegram web app init : \", res.success);\n                console.info(\"Init Data: \" + decodeURIComponent(TelegramWebApp.Instance.getTelegramInitData()));\n                this.debugInfo.string = \"Init Data: \" + decodeURIComponent(TelegramWebApp.Instance.getTelegramInitData());\n                this.tgLogin(TelegramWebApp.Instance.getTelegramInitData());\n            });   \n        }\n    }\n\n    start() {\n\n    }\n\n    update(deltaTime: number) {\n\n    }\n\n    public onConnect() {\n        if (this.isConnected(true)) {\n            this.doDisconnect();\n        } else {\n            this.connectUI.openModal();\n        }\n    }\n\n    public onDanceEnd() {\n        //for test\n        this.danceEnd(200);\n        //--\n    }\n\n    //Telegram小游戏分享\n    public onShare() {\n        console.info(\"share \");\n        TelegramWebApp.Instance.share(\"https://t.me/MyTestGame029Bot/TgTest?start=invite_\" + this._user.tg_id, \"Invite you to play a very interesting game\");\n    }\n\n    //初始化ton connect ui\n    private initTonConnect() {\n        this.connectUI = new TonConnectUI({\n            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json'\n        });\n      \n\n        // Listen for connection status changes\n        this.connectUI.onModalStateChange(state => {\n            console.log(\"model state changed! : \", state);\n            this.updateConnect();\n        });\n\n        // Listen for wallet status changes\n        this.connectUI.onStatusChange(info => {\n            console.log(\"wallet info status changed : \", info);\n            this.updateConnect();\n        });\n    }\n\n    private isConnected(checkBindWallet:boolean): boolean {\n        if (!this.connectUI) {\n            console.error(\"ton ui not inited!\");\n            return false;\n        }\n\n        if (checkBindWallet) {\n            if (this._user != null && this._user.ton_wallet != \"\") {\n                return true;\n            }\n        }\n\n        return this.connectUI.connected;\n    }\n\n    private async doDisconnect() {\n        if (this.connectUI.connected) {\n            this.connectUI.disconnect();\n        } else {\n            await this.unbindWallet();\n            this._user.ton_wallet = \"\";\n            this.addressLbl.string = \"Address: \";\n            this.connectLbl.string = \"Connect\";\n        }\n    }\n\n    // Get the wallet address after successful connection\n    private async updateConnect() {\n        if (this.isConnected(false)) {\n            //用户连接的钱包地址\n            var strAddress: string = Address.parseRaw(this.connectUI.account.address).toString({ testOnly: false, bounceable: false });\n            this._user.ton_wallet = await this.bindTonWallet(strAddress);\n            this.addressLbl.string = \"Address: \" + this._user.ton_wallet;\n            this.connectLbl.string = \"Connected\";\n        } else {\n            await this.unbindWallet();\n            this._user.ton_wallet = \"\";\n            this.addressLbl.string = \"Address: \";\n            this.connectLbl.string = \"Connect\";\n        }\n    }\n\n    private setUserInfo(response: ResponseLogin) {\n        this._user = response.user;\n        this._token = response.token;\n        this.idLbl.string = \"id: \" + this._user.tg_id.toString();\n        //优先显示username\n        if (this._user.username != \"\") {\n            this.nameLbl.string = \"name: \" + this._user.username;\n        } else {\n            this.nameLbl.string = \"name: \" + this._user.first_name + \" \" + this._user.last_name;\n        }\n        \n        this.addressLbl.string = \"Address: \" + this._user.ton_wallet;\n        this.connectLbl.string = this.isConnected(true) ? \"Connected\" : \"Connect\";\n        this.pointsLbl.string = \"Points: \" + this._user.points.toString();\n    }\n\n    //以下接口请求\n    //test登录接口, 无需授权\n    private async testLogin() {\n        try {\n            var data = 'user=' + encodeURIComponent('{\"id\":1,\"first_name\":\"yingbin\",\"last_name\":\"liu\",\"username\":\"daniel029\"}') + '&auth_date=1&hash=2&signature=3';\n            console.info(data);\n\n            var response = await HttpClient.post<ResponseLogin>(this._base_url, this._test_login_path, \"application/x-www-form-urlencoded\", data);\n            this.setUserInfo(response);\n            this.debugInfo.string = \"\";\n        } catch(error) {\n            console.error(error);\n        }\n    }\n\n    //正式的telegram小游戏授权登录接口\n    private async tgLogin(initData:string) {\n        try {\n            console.info(\"tg login: \", initData);\n            var response = await HttpClient.post<ResponseLogin>(this._base_url, this._login_path, \"application/x-www-form-urlencoded\", initData);\n            this.setUserInfo(response);\n            this.debugInfo.string = \"\";\n        } catch(error) {\n            console.error(error);\n            this.debugInfo.string = \"error: \" + error.toString();\n        }\n    }\n\n    //绑定钱包接口\n    private async bindTonWallet(wallet:string) {\n        try {\n            if (this._token == \"\") {\n                return \"\";\n            }\n\n            console.info(\"bindWallet: \", wallet);\n            var dic = {\n                \"wallet\": wallet\n            }\n            var response = await HttpClient.post<ResponseBindWallet>(this._base_url, this._bind_ton_wallet_path, \"application/json\", dic, this._token);\n            this.debugInfo.string = \"\";\n            return response.wallet;\n\n        } catch(error) {\n            console.error(error);\n            this.debugInfo.string = \"error: \" + error.toString();\n        }\n    }\n\n    //取消绑定接口\n    private async unbindWallet() {\n        try {\n            if (this._token == \"\") {\n                return;\n            }\n            console.info(\"unBindWallet\");\n            await HttpClient.post<ResponseUnBindWallet>(this._base_url, this._unbind_ton_wallet_path, \"application/json\", {}, this._token);\n            this.debugInfo.string = \"\";\n        } catch(error) {\n            console.error(error);\n            this.debugInfo.string = \"error: \" + error.toString();\n        }\n    }\n\n    //跳舞接受后积分统计接口\n    private async danceEnd(addPoints: number) {\n        try {\n            if (this._token == \"\") {\n                return 0;\n            }\n\n            console.info(\"danceEnd: \", addPoints);\n            var dic = {\n                \"points\": addPoints\n            }\n            var response = await HttpClient.post<ResponseDanceEnd>(this._base_url, this._dance_end_path, \"application/json\", dic, this._token);\n            this._user.points = response.points;\n            this.pointsLbl.string = \"Points: \" + this._user.points.toString();\n            this.debugInfo.string = \"\";\n        } catch(error) {\n            console.error(error);\n            this.debugInfo.string = \"error: \" + error.toString();\n        }\n    }\n}\n\n","import { _decorator} from 'cc';\n\nexport interface FetchOptions {\n    method?: string;\n    headers?: HeadersInit;\n    body?: BodyInit;\n}\n\nexport class HttpClient {\n    /**\n     * GET 请求\n     */\n    public static async request<T>(url: URL, options?: FetchOptions): Promise<T> {\n        try {\n            const response = await fetch(url, options);\n\n            if (!response.ok) {\n                throw new Error(`请求失败: ${response.status} - ${response.statusText}`);\n            }\n\n            return await response.json() as T;\n        } catch (error) {\n            console.error('网络请求错误:', error);\n            throw error;\n        }\n    }\n\n    // GET 请求\n    public static async get<T>(baseUrl: string, path: string, contentType: string, params?: Record<string, any>, authToken?: string) {\n        const url = new URL(path, baseUrl);\n        if (params) {\n            params.forEach(([key, value]) => {\n                url.searchParams.append(key, value as string);\n            });\n        }\n        var headers = {'Content-Type': contentType};\n        if (authToken) {\n            headers['Authorization'] = `Bearer ${authToken}`;\n        }\n        return HttpClient.request<T>(url, {\n            method: 'GET',\n            headers: headers\n        });\n    }\n\n    // POST 请求\n    public static async post<T>(baseUrl: string, path: string, contentType: string, data?: any, authToken?: string) {\n        const url = new URL(path, baseUrl);\n        var headers = {'Content-Type': contentType};\n        if (authToken) {\n            headers['Authorization'] = `Bearer ${authToken}`;\n        }\n        return HttpClient.request<T>(url, {\n            method: 'POST',\n            headers: headers,\n            body: contentType == \"application/json\" ? JSON.stringify(data) : data,\n        });\n    }\n}","import { _decorator, Canvas, CCBoolean, CCInteger, Component, Node, ResolutionPolicy, View } from 'cc';\nimport { LogManager } from '../../scripts/framework/common/LogManager';\nconst { ccclass, property } = _decorator;\n\n@ccclass('ResolutionAdjuster')\nexport class ResolutionAdjuster extends Component {\n    @property(CCInteger)\n    fixedWidthDesignWidth: number = 1280;\n    @property(CCInteger)\n    fixedWidthDesignHeight: number = 720;\n\n    @property(CCInteger)\n    fixedHeightDesignWidth: number = 720;\n    @property(CCInteger)\n    fixedHeightDesignHeight: number = 1280;\n\n    @property(CCBoolean)\n    isAutoFit: boolean = true;\n\n    protected onLoad(): void {\n        if (this.isAutoFit)\n        {\n            this.autoFit();\n            window.addEventListener('resize', this.autoFit.bind(this));\n            // Screen.on('orientation-change', this.autoFit.bind(this));\n        }\n    }\n\n    protected start(): void {\n        if (this.isAutoFit)\n        {\n            this.autoFit();\n        }\n    }\n\n    private autoFit(): void {\n\n        let designSize = View.instance.getDesignResolutionSize();\n        // console.log(`desginSize = ${designSize}`);\n\n        // let visibleSize = View.instance.getVisibleSize();\n        // console.log(`visibleSize = ${visibleSize}`);\n\n        let viewPortRect = View.instance.getViewportRect();\n        View.instance.setOrientation\n        console.log(`viewPortRect = ${viewPortRect}`);\n        \n        let rateR = designSize.height / designSize.width;\n        let rateV = Math.abs(viewPortRect.size.height) / Math.abs(viewPortRect.size.width);\n        \n        // let rp = ResolutionPolicy.FIXED_HEIGHT;\n        // if (rateV < 1.0)\n        // {\n        //     rp = ResolutionPolicy.FIXED_WIDTH;\n        // }\n\n        console.log(`rateV = ${rateV}`)\n        if (rateV < 1.0)\n        {\n            View.instance.setDesignResolutionSize(this.fixedWidthDesignWidth, this.fixedWidthDesignHeight, ResolutionPolicy.FIXED_WIDTH);\n        }\n        else\n        {\n            View.instance.setDesignResolutionSize(this.fixedHeightDesignWidth, this.fixedHeightDesignHeight, ResolutionPolicy.FIXED_HEIGHT);\n        }\n    }\n}\n\n\n","import { _decorator, sys } from 'cc';\nconst { ccclass, property } = _decorator;\n\n\nconst tgLoadPromise = new Promise<any>((resolve, reject) => {\n    if (sys.platform === sys.Platform.MOBILE_BROWSER || sys.platform === sys.Platform.DESKTOP_BROWSER) {\n        const script = document.createElement(\"script\");\n        script.src = \"https://telegram.org/js/telegram-web-app.js\";\n        script.async = true;\n        script.onload = () => {\n            const intervalId = setInterval(() => {\n                if ((window as any).Telegram && (window as any).Telegram.WebApp) {\n                    resolve((window as any).Telegram.WebApp);\n                    clearInterval(intervalId);\n                }\n            }, 100);\n        };\n        script.onerror = () => reject(new Error(\"Unable to load TelegramWebApp SDK, please check logs.\"));\n        document.head.appendChild(script);\n    }\n});\n\nexport interface WebAppUser {\n    id: number;\n    is_bot: boolean;\n    first_name: string;\n    last_name?: string;\n    username?: string;\n    language_code?: string;\n    is_premium?: boolean;\n    added_to_attachment_menu?: boolean;\n    allows_write_to_pm?: boolean;\n    photo_url?: string;\n}\nexport interface WebAppChat {\n    id: number;\n    type: 'private' | 'group' | 'supergroup' | 'channel';\n    title: string;\n    username?: string;\n    photo_url?: string;\n}\nexport interface WebAppInitData {\n    query_id?: string;\n    user?: WebAppUser;\n    receiver?: WebAppUser;\n    chat?: WebAppChat;\n    chat_type?: 'private' | 'group' | 'supergroup' | 'channel';\n    chat_instance?: string;\n    start_param?: string;\n    can_send_after?: number;\n    auth_data: number;\n    hash: string;\n}\n\n@ccclass('TelegramWebApp')\nexport class TelegramWebApp {\n    private static _instance: TelegramWebApp;\n    private constructor() {\n\n    }\n    public static get Instance(): TelegramWebApp {\n        if (!TelegramWebApp._instance) {\n            TelegramWebApp._instance = new TelegramWebApp();\n        }\n        return TelegramWebApp._instance;\n    }\n\n    private _tgWebAppJS: any = null;\n    public async init(): Promise<{ success: boolean }> {\n        this._tgWebAppJS = await tgLoadPromise;\n\n        if (this._tgWebAppJS) {\n            return Promise.resolve({ success: true });\n        } else {\n            return Promise.resolve({ success: false });\n        }\n    }\n\n    public openTelegramLink(url: string) {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return;\n        }\n        this._tgWebAppJS.openTelegramLink(url);\n    }\n\n    public openLink(url: string, options: any = {}) {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return;\n        }\n        this._tgWebAppJS.openLink(url, options);\n    }\n\n    public share(url: string, text?: string) {\n        const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text || '');\n        this.openTelegramLink(shareUrl);\n    }\n\n    public shareToStory(media_url: string, shareText?: string, widget_link_url?: string, widget_link_name?: string) {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return;\n        }\n        const widget_link = {\n            text: shareText,\n            widget_link: {\n                url: widget_link_url,\n                name: widget_link_name,\n            },\n        };\n        this._tgWebAppJS.shareToStory(media_url, widget_link);\n    }\n\n    public getTelegramWebApp() {\n        return this._tgWebAppJS;\n    }\n\n    public getTelegramWebAppInitData(): WebAppInitData {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return null;\n        }\n        return this._tgWebAppJS.initDataUnsafe;\n    }\n\n\n    public getTelegramUser(): WebAppUser {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return null;\n        }\n        return this._tgWebAppJS.initDataUnsafe.user;\n    }\n\n    public getTelegramInitData(): string {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return null;\n        }\n        return this._tgWebAppJS.initData;\n    }\n\n    public openInvoice(url: string, callback: any) {\n        if (!this._tgWebAppJS) {\n            console.error(\"telegram web app is not inited!\");\n            return null;\n        }\n        this._tgWebAppJS.openInvoice(url, callback);\n    }\n\n    public alert(message: string) {\n        this._tgWebAppJS.showAlert(message);\n    }\n}\n\n\n"]}